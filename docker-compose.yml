version: '3.8'

services:
  device:
    build: .
    platform: linux/arm64  # Platform specification to match Dockerfile
    ports:
      - "5002:5002"
    environment:
      - FLASK_ENV=development
      - WEB3_PROVIDER=http://52.78.52.216:8545
      - WEB3_WS_PROVIDER=ws://52.78.52.216:8545
      - IPFS_API=/ip4/52.78.52.216/tcp/5001/http # ipfshttpclientìš©
      - IPFS_GATEWAY=http://52.78.52.216:8080  # HTTP ë‹¤ìš´ë¡œë“œìš©
      - MANUFACTURER_API_URL=http://52.78.52.216:5002
      - DEVICE_API_PORT=5002
      - CP_ABE_DEBUG=1  # Enable CP-ABE debug logging
      - GOOGLE_APPLICATION_CREDENTIALS=/app/electric-vision-465910-b0-fd08e1f02d86.json
      - HF_TOKEN=${HF_TOKEN}
      - TORCH_CPP_LOG_LEVEL=ERROR
      - DBUS_SESSION_BUS_ADDRESS=/dev/null
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # devices:
    #   - "/dev/snd:/dev/snd"  # ðŸ”ˆ ì˜¤ë””ì˜¤ ìž¥ì¹˜ ë°”ì¸ë”©
    # privileged: true         # ðŸ” ìž¥ì¹˜ ì ‘ê·¼ ê¶Œí•œ ë¶€ì—¬
    volumes:
      - ./client/keys:/app/client/keys
      - ./data:/app/data
      # - /home/soda/Blocker/sy:/app/client/updates # ì—…ë°ì´íŠ¸ íŒŒì¼ì„ /soda/Blockerì— ì €ìž¥
  
  #nlu, llm ì¶”ê°€ rsa -> nluë¶„ë¥˜, rasa_action -> llmì „ë‹¬ ë° ì°¨ëŸ‰ì œì–´, llm_fallback -> llm í†µì‹ 
  rasa:
    image: rasa/rasa:3.5.10
    container_name: rasa_app
    volumes:
      - ./llm:/app
    command: run --enable-api --port 5005
    ports:
      - "5005:5005"
    depends_on:
      - rasa_action
  rasa_action:
    build: ./llm/actions
    ports:
      - "5055:5055"
    container_name: rasa_action_server

  llm_fallback:
    build:
      context: ./llm_fallback
      args:
        HF_TOKEN: ${HF_TOKEN}
    ports:
      - "5000:5000"
    container_name: llm_fallback_server
    environment:
      - HF_TOKEN=${HF_TOKEN}

